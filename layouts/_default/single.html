{{ define "main" }}

<div class="controls">
    <button class="btn" id="prev-page" onclick="previousPage()">
        <i class="fas fa-chevron-right"></i>
        السابق
    </button>
    
    <div class="page-info">
        صفحة <span id="current-page">1</span> من <span id="total-pages">-</span>
    </div>
    
    <button class="btn" id="next-page" onclick="nextPage()">
        التالي
        <i class="fas fa-chevron-left"></i>
    </button>

    <div class="zoom-controls">
        <button class="btn" onclick="zoomOut()">
            <i class="fas fa-search-minus"></i>
        </button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="btn" onclick="zoomIn()">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="btn" onclick="resetZoom()">
            <i class="fas fa-compress"></i>
        </button>
    </div>
</div>

<div class="pdf-container">
    <div id="loading" class="loading">
        <i class="fas fa-spinner"></i>
        <p>جاري تحميل الكتاب...</p>
    </div>
    <canvas id="pdf-canvas" style="display: none;"></canvas>
    <div id="error" class="error" style="display: none;"></div>
</div>

<script>
    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let currentZoom = 1.0;
    const pdfFile = '{{ .Site.Params.pdf_file }}';

    // Initialize PDF viewer
    async function initPDFViewer() {
        try {
            const loadingElement = document.getElementById('loading');
            const canvas = document.getElementById('pdf-canvas');
            const errorElement = document.getElementById('error');

            // Load PDF document
            const loadingTask = pdfjsLib.getDocument(pdfFile);
            pdfDoc = await loadingTask.promise;
            
            totalPages = pdfDoc.numPages;
            document.getElementById('total-pages').textContent = totalPages;
            
            // Hide loading, show canvas
            loadingElement.style.display = 'none';
            canvas.style.display = 'block';
            
            // Render first page
            await renderPage(currentPage);
            updateButtons();
            
        } catch (error) {
            console.error('Error loading PDF:', error);
            document.getElementById('loading').style.display = 'none';
            const errorElement = document.getElementById('error');
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <p>حدث خطأ أثناء تحميل الكتاب</p>
                <p>الرجاء التأكد من وجود ملف PDF: ${pdfFile}</p>
            `;
        }
    }

    // Render a specific page
    async function renderPage(pageNumber) {
        if (!pdfDoc) return;

        try {
            const page = await pdfDoc.getPage(pageNumber);
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');

            // Calculate viewport with current zoom
            const viewport = page.getViewport({ scale: currentZoom });
            
            // Set canvas dimensions
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // Render PDF page
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            
            // Update page info
            document.getElementById('current-page').textContent = pageNumber;
            
        } catch (error) {
            console.error('Error rendering page:', error);
        }
    }

    // Navigation functions
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            updateButtons();
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            updateButtons();
        }
    }

    // Zoom functions
    function zoomIn() {
        currentZoom = Math.min(currentZoom + 0.25, 3.0);
        renderPage(currentPage);
        updateZoomLevel();
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom - 0.25, 0.5);
        renderPage(currentPage);
        updateZoomLevel();
    }

    function resetZoom() {
        currentZoom = 1.0;
        renderPage(currentPage);
        updateZoomLevel();
    }

    function updateZoomLevel() {
        document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
    }

    // Update button states
    function updateButtons() {
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    // Keyboard navigation
    document.addEventListener('keydown', (event) => {
        switch(event.key) {
            case 'ArrowRight':
                previousPage();
                break;
            case 'ArrowLeft':
                nextPage();
                break;
            case '+':
            case '=':
                zoomIn();
                break;
            case '-':
            case '_':
                zoomOut();
                break;
            case '0':
                resetZoom();
                break;
        }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initPDFViewer);
</script>

{{ end }}
