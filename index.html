{{ define "main" }}

<div class="controls">
    <button class="btn" id="prev-page" onclick="previousPage()">
        <i class="fas fa-chevron-right"></i>
        السابق
    </button>
    
    <div class="page-info">
        صفحة <span id="current-page">1</span> من <span id="total-pages">-</span>
    </div>
    
    <button class="btn" id="next-page" onclick="nextPage()">
        التالي
        <i class="fas fa-chevron-left"></i>
    </button>

    <div class="zoom-controls">
        <button class="btn" onclick="zoomOut()">
            <i class="fas fa-search-minus"></i>
        </button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="btn" onclick="zoomIn()">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="btn" onclick="resetZoom()">
            <i class="fas fa-compress"></i>
        </button>
    </div>
</div>

<div class="pdf-container">
    <div id="loading" class="loading">
        <i class="fas fa-spinner"></i>
        <p>جاري تحميل الكتاب...</p>
    </div>
    
    <!-- Primary: Canvas-based viewer -->
    <canvas id="pdf-canvas" style="display: none;"></canvas>
    
    <!-- Fallback: iframe viewer -->
    <iframe id="pdf-iframe" style="display: none; width: 100%; height: 800px; border: none;" 
            src="{{ .Site.Params.pdf_file }}#toolbar=0&navpanes=0&scrollbar=0"></iframe>
    
    <!-- Toggle button for alternative viewer -->
    <div id="viewer-toggle" style="display: none; text-align: center; margin: 10px;">
        <button class="btn" onclick="toggleViewer()">
            <i class="fas fa-exchange-alt"></i>
            تبديل طريقة العرض
        </button>
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
</div>

<script>
    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let currentZoom = 1.0;
    let useCanvasViewer = true; // Track which viewer is active
    const pdfFile = '{{ .Site.Params.pdf_file }}';

    // Toggle between canvas and iframe viewer
    function toggleViewer() {
        const canvas = document.getElementById('pdf-canvas');
        const iframe = document.getElementById('pdf-iframe');
        const controls = document.querySelector('.controls');
        
        useCanvasViewer = !useCanvasViewer;
        
        if (useCanvasViewer) {
            canvas.style.display = 'block';
            iframe.style.display = 'none';
            controls.style.display = 'flex';
        } else {
            canvas.style.display = 'none';
            iframe.style.display = 'block';
            controls.style.display = 'none'; // Hide controls for iframe
        }
    }

    // Initialize PDF viewer
    async function initPDFViewer() {
        try {
            const loadingElement = document.getElementById('loading');
            const canvas = document.getElementById('pdf-canvas');
            const errorElement = document.getElementById('error');

            // Configure PDF.js for Arabic text support
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Enhanced PDF loading with Arabic support
            const loadingTask = pdfjsLib.getDocument({
                url: pdfFile,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true,
                standardFontDataUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/standard_fonts/',
                useSystemFonts: true,
                useWorkerFetch: true,
                isEvalSupported: false,
                disableFontFace: false,
                nativeImageDecoderSupport: 'none'
            });
            
            pdfDoc = await loadingTask.promise;
            
            // Get PDF metadata for better rendering
            const metadata = await pdfDoc.getMetadata();
            console.log('PDF Info:', metadata);
            
            totalPages = pdfDoc.numPages;
            document.getElementById('total-pages').textContent = totalPages;
            
            // Hide loading, show canvas
            loadingElement.style.display = 'none';
            canvas.style.display = 'block';
            
            // Render first page
            await renderPage(currentPage);
            updateButtons();
            
        } catch (error) {
            console.error('Error loading PDF:', error);
            
            // Fallback to iframe viewer if canvas fails
            const loadingElement = document.getElementById('loading');
            const canvas = document.getElementById('pdf-canvas');
            const iframe = document.getElementById('pdf-iframe');
            const toggle = document.getElementById('viewer-toggle');
            const controls = document.querySelector('.controls');
            
            loadingElement.style.display = 'none';
            canvas.style.display = 'none';
            iframe.style.display = 'block';
            toggle.style.display = 'block';
            controls.style.display = 'none';
            
            useCanvasViewer = false;
        }
    }

    // Render a specific page
    async function renderPage(pageNumber) {
        if (!pdfDoc) return;

        try {
            const page = await pdfDoc.getPage(pageNumber);
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');

            // Get page viewport with precise scaling
            const viewport = page.getViewport({ 
                scale: currentZoom,
                rotation: 0,
                dontFlip: false
            });
            
            // Set canvas dimensions to match viewport exactly
            canvas.width = Math.floor(viewport.width);
            canvas.height = Math.floor(viewport.height);
            
            // Clear canvas with white background
            context.fillStyle = '#ffffff';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // Set up text rendering for Arabic
            context.textBaseline = 'bottom';
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            
            // Render page with enhanced text support
            const renderContext = {
                canvasContext: context,
                viewport: viewport,
                intent: 'display',
                enableWebGL: false,
                renderInteractiveForms: false,
                annotationMode: pdfjsLib.AnnotationMode.ENABLE,
                transform: null,
                background: null
            };
            
            // Render the page
            const renderTask = page.render(renderContext);
            await renderTask.promise;
            
            // Update page info
            document.getElementById('current-page').textContent = pageNumber;
            
        } catch (error) {
            console.error('Error rendering page:', error);
            // Fallback: try simpler rendering
            try {
                const page = await pdfDoc.getPage(pageNumber);
                const canvas = document.getElementById('pdf-canvas');
                const context = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: currentZoom });
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                document.getElementById('current-page').textContent = pageNumber;
            } catch (fallbackError) {
                console.error('Fallback rendering also failed:', fallbackError);
            }
        }
    }

    // Navigation functions
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            updateButtons();
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            updateButtons();
        }
    }

    // Zoom functions
    function zoomIn() {
        currentZoom = Math.min(currentZoom + 0.25, 3.0);
        renderPage(currentPage);
        updateZoomLevel();
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom - 0.25, 0.5);
        renderPage(currentPage);
        updateZoomLevel();
    }

    function resetZoom() {
        currentZoom = 1.0;
        renderPage(currentPage);
        updateZoomLevel();
    }

    function updateZoomLevel() {
        document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
    }

    // Update button states
    function updateButtons() {
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    // Keyboard navigation
    document.addEventListener('keydown', (event) => {
        switch(event.key) {
            case 'ArrowRight':
                previousPage();
                break;
            case 'ArrowLeft':
                nextPage();
                break;
            case '+':
            case '=':
                zoomIn();
                break;
            case '-':
            case '_':
                zoomOut();
                break;
            case '0':
                resetZoom();
                break;
        }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initPDFViewer);
</script>

{{ end }}
